<!DOCTYPE html>
<html lang="en" data-theme="lofi">
  <head>
    <!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<meta name="generator" content="Astro v2.5.7">

<!-- Primary Meta Tags -->
<title>Understanding Solidity Part 3: Virtual Machine</title>
<meta name="title" content="Understanding Solidity Part 3: Virtual Machine">
<meta name="description" content="In the previous part we've written a Solidity grammar, or at least we've written enough to parse our example contract. Today we'll go one step further and make it actually run by writing our own stack-based virtual machine.">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://astro-modern-personal-website.netlify.app/blog/understanding-solidity-part-3/">
<meta property="og:title" content="Understanding Solidity Part 3: Virtual Machine">
<meta property="og:description" content="In the previous part we've written a Solidity grammar, or at least we've written enough to parse our example contract. Today we'll go one step further and make it actually run by writing our own stack-based virtual machine.">
<meta property="og:image" content="https://astro-modern-personal-website.netlify.app/tinysol_part3.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://astro-modern-personal-website.netlify.app/blog/understanding-solidity-part-3/">
<meta property="twitter:title" content="Understanding Solidity Part 3: Virtual Machine">
<meta property="twitter:description" content="In the previous part we've written a Solidity grammar, or at least we've written enough to parse our example contract. Today we'll go one step further and make it actually run by writing our own stack-based virtual machine.">
<meta property="twitter:image" content="https://astro-modern-personal-website.netlify.app/tinysol_part3.png">
  <link rel="stylesheet" href="/_astro/404.237ea004.css" />
<link rel="stylesheet" href="/_astro/_slug_.af480368.css" /><script type="module">const s=document.getElementById("home"),o=document.getElementById("projects"),c=document.getElementById("services"),d=document.getElementById("store"),i=document.getElementById("blog"),l=document.getElementById("cv");var t=!0;const m=window.location.href,a=[o,c,d,i,l],n="bg-base-300";a.forEach(e=>{e?.id&&m.includes(e.id)&&(t=!1,e?.classList.add(n))});t&&s?.classList.add(n);
</script></head>
  <body>
    <div class="bg-base-100 drawer drawer-mobile">
      <input id="my-drawer" type="checkbox" class="drawer-toggle">
      <div class="drawer-content flex flex-col bg-base-100">
        <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm">
  <div class="navbar">
    <div class="navbar-start">
      <label for="my-drawer" class="btn btn-square btn-ghost">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </label>
    </div>
    <div class="navbar-center">
      <a class="btn btn-ghost normal-case text-xl" href="/">Theo Hallenius</a>
    </div>
    <div class="navbar-end"></div>
  </div>
</div>
        <div class="md:flex md:justify-center">
          <main class="p-6 pt-10 max-w-[900px]">
            
  <main class="md:flex md:justify-center">
    <article class="prose prose-lg max-w-[750px] prose-img:mx-auto">
      <img alt="Understanding Solidity Part 3: Virtual Machine" class="w-full mb-6" width="750" height="422" src="/_astro/tinysol_part3_Zj9Xrr.webp" loading="lazy" decoding="async">
      <h1 class="title my-2 text-4xl font-bold">Understanding Solidity Part 3: Virtual Machine</h1>
      <time>Jul 10, 2023</time>
      <br>
      
      
      <div class="divider my-2"></div>
      
    <p>Part 1 and Part 2:</p>
<div class="rounded-lg bg-base-100 hover:shadow-xl transition ease-in-out hover:scale-[102%]">
  <a href="/blog/understanding-solidity-part-1" target="_self">
    <div class="hero-content flex-col md:flex-row">
      <img alt="Understanding Solidity Part 1: Project Setup" class="max-w-full md:max-w-[13rem] rounded-lg" width="750" height="422" src="/_astro/tinysol_part1_ZlQu7d.webp" loading="lazy" decoding="async">
      <div class="grow w-full">
        <h1 class="text-xl font-bold">
          Understanding Solidity Part 1: Project Setup
          
        </h1>
        <p class="py-1 text-1xl">The best way to understand something is to build it from scratch and we&#39;re about to do just that...</p>
        <div class="card-actions justify-end">
          
        </div>
      </div>
    </div>
  </a>
</div>
<div class="rounded-lg bg-base-100 hover:shadow-xl transition ease-in-out hover:scale-[102%]">
  <a href="/blog/understanding-solidity-part-2" target="_self">
    <div class="hero-content flex-col md:flex-row">
      <img alt="Understanding Solidity Part 2: Parser and Grammar" class="max-w-full md:max-w-[13rem] rounded-lg" width="750" height="422" src="/_astro/tinysol_part2_sOYgg.webp" loading="lazy" decoding="async">
      <div class="grow w-full">
        <h1 class="text-xl font-bold">
          Understanding Solidity Part 2: Parser and Grammar
          
        </h1>
        <p class="py-1 text-1xl">This is the Part 2 of our tutorial series on how to build a Solidity parser and virtual machine in Rust 🦀. Now to the fun part, we&#39;re going to continue defining our grammar...</p>
        <div class="card-actions justify-end">
          
        </div>
      </div>
    </div>
  </a>
</div>
<p>In the previous part we’ve written a Solidity grammar, or at least we’ve written enough to parse our example contract. Today we’ll go one step further and make it actually run by writing our own stack-based virtual machine.
If you somehow missed the previous tutorial - you can download the source code from <a href="https://github.com/TheoXD/tinysol/archive/6ecf74c8afef3e4bf90a81a312d91bdda923995f.zip">here</a>.
This part will involve a lot of Rust, but I’ll gradually introduce new Rust concepts for those who are new to the language so that anyone reading it can follow along.
<img src="/rust-book.png" alt="Rust Book"/></p>
<h1 id="stack">Stack</h1>
<p>EVM is a <strong>stack based</strong> virtual machine. It means that all operations occur on the stack data structure. While queues are FIFO (first in first out), stacks are LIFO (last in first out). If you don’t know what a queue is, you’ve probably been in one.</p>
<p>In essence EVM stack is just an array of unsigned 256bit integers sometimes referred to as <code>words</code>. The stack is limited to 1024 words in total with 32 bytes each, so that’s a limit of 32 MB.
Since Rust doesn’t natively support 256bit integers, we’ll use the <code>ethnum</code> crate. Let’s add it to our dependency:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">[</span><span style="color:#B392F0">dependencies</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">ethnum = </span><span style="color:#9ECBFF">&quot;1.3.2&quot;</span></span></code></pre>
<p>Create a new module <code>tinyvm.rs</code> inside our <code>src/</code> folder and import the U256 type as well as types from our grammar:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ethnum</span><span style="color:#F97583">::</span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">crate::</span><span style="color:#B392F0">solidity</span><span style="color:#F97583">::</span><span style="color:#B392F0">grammar</span><span style="color:#F97583">::*</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>And our newly created module to our <code>main.rs</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mod</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">solidity</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mod</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">tinyvm</span><span style="color:#E1E4E8">;</span><span style="color:#6A737D"> // &lt;--- Add this</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">crate::</span><span style="color:#B392F0">tinyvm</span><span style="color:#F97583">::*</span><span style="color:#E1E4E8">;</span><span style="color:#6A737D"> // &lt;--- Add this</span></span></code></pre>
<p>Now go back to our newly created <code>tinyvm.rs</code> module and declare a struct that will hold our stack:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Stack</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    stackarr</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">1024</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    top</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>All we need now is to implement some of the most common stack operations, like <code>push</code>, <code>pop</code> and <code>swap</code>, as all stacks share those in common. EVM in particular has multiple push operations, 32 in fact, but since we’re dealing with booleans we won’t need the entire range of opcodes and just need <code>push1</code> and <code>push</code> for now.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Stack</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            stackarr</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ZERO</span><span style="color:#E1E4E8">; </span><span style="color:#79B8FF">1024</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">            top</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1024</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stackarr[</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value;</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">push1</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, value</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(value));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">None</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stackarr[</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top])</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span><span style="color:#6A737D">   //no semicolon in Rust means this expression is returned, </span></span>
<span class="line"><span style="color:#6A737D">            //and it will return either None or Some() depending on the condition</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">swap</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stackarr</span><span style="color:#F97583">.</span><span style="color:#B392F0">swap</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">top </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
Rust doesn’t have inheritance or prototypes like in other object oriented programming languages. Instead it has traits that allow us to extend functionality of any type, including built-in ones. Also note the lack of semicolons and lack of <code>return</code> keyword, as in Rust you don’t need to explicitly return a value from a function.</p>
</blockquote>
<p>Both <code>push</code> and <code>pop</code> are pretty self explanatory. <code>push</code> adds one element on top of the stack while <code>pop</code> removes the top most element of the stack. <code>swap</code> swaps the two top most elements.</p>
<p>EVM has over 140 opcodes, but in order to run our little contract we’d only need a small subset of those. Let’s also declare some of the OPcodes we’re actually going to use:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">enum</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">PUSH32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">PUSH1</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">POP</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">DUP1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">SWAP1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">SLOAD</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">SSTORE</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">ISZERO</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#79B8FF">RETURN</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h1 id="storage">Storage</h1>
<p>In order to store state variables we need contract storage. It’s simply an array of unsigned 256bit integers where each state variable is stored in a separate slot, so our state variable would be stored at slot 0 (or index 0).</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractStorage</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    slots</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">U256</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>SLOAD and SSTORE OPcodes will be used to read and write to this storage.</p>
<h1 id="tiny-virtual-machine">Tiny Virtual Machine</h1>
<p>A virtual machine is something that steps through each OPcode and evaluates them. Our VM just needs a stack, a program to execute, a program counter and calldata.
Calldata is an immutable storage type that contains the function name and arguments passed to that function as raw bytes, where the first 4 bytes are the function signature. For now we’re going to assume that our calldata only contains function signature.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">VM</span><span style="color:#E1E4E8">&lt;&#39;</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> stack</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Stack</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    program</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">    pc</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    calldata</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8">&#39;</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>It’s implementation looks like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8">&lt;&#39;</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">&gt; </span><span style="color:#79B8FF">VM</span><span style="color:#E1E4E8">&lt;&#39;</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(program</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt;, calldata</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8">&#39;</span><span style="color:#B392F0">a</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            stack</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Stack</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            program,</span></span>
<span class="line"><span style="color:#E1E4E8">            pc</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            calldata</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> calldata,</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, storage</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractStorage</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractStorage</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> storage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> storage;</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">while</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">program</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">program[</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc] {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH32</span><span style="color:#E1E4E8">(word) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH1</span><span style="color:#E1E4E8">(value) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">POP</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">DUP1</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SWAP1</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SLOAD</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SSTORE</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">RETURN</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ISZERO</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#E1E4E8">        storage</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
You’re probably wondering what the heck are <code>&lt;&#39;a&gt;</code>, <code>&amp;&#39;a</code> and <code>&lt;&#39;_&gt;</code>. That’s a lifetime with arbitrary name <code>a</code> that we created for our calldata byte array, we’re basically telling the Rust compiler that this data should live as long as our VM instance lives. No need to manually allocate/deallocate memory.
todo!() is a macro that will result in our program panicing when called. It’s useful for prototyping as we’ll know if we forgot to implement something while still allowing us to compile and run.</p>
</blockquote>
<p>Here we iterate over the instruction set and use Rust’s pattern matching syntax to match each instruction. Kinda like switch case expression in other languages but way more powerful.
For every new VM instance we pass it a set of instructions to execute as an argument, and when we run it we pass it a <code>ContractStorage</code> to execute on, returning modified contract storage.</p>
<p>Now let’s implement the OPcodes:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH32</span><span style="color:#E1E4E8">(word) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(word);</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH1</span><span style="color:#E1E4E8">(value) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push1</span><span style="color:#E1E4E8">(value);</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">POP</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SWAP1</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">swap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">DUP1</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> top </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(top);</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(top);</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SLOAD</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> val </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> storage</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">slots[key</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_usize</span><span style="color:#E1E4E8">()];</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(val);</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SSTORE</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> val </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                    storage</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">slots[key</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_usize</span><span style="color:#E1E4E8">()] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> val;</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span></code></pre>
<p>SLOAD loads a state variable from storage with top most element as key.
SSTORE stores a state variable to storage with top most element as key and second top most element as value.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">RETURN</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span></code></pre>
<p>RETURN OPCode stops the program execution and breaks the loop.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ISZERO</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> top </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> top </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ZERO</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ONE</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">                    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">push32</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ZERO</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">pc </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span></code></pre>
<p>ISZERO OPCode looks at the top most element of the stack and replaces it with either 1 or 0 depending on whether it’s zero or not, so it flips the value.</p>
<p>Now what we’re missing is an instruction set to run and a way to interact with our VM.</p>
<h1 id="putting-it-all-together">Putting it all together</h1>
<p>Start by adding these two structs and these two enums to our <code>tinyvm.rs</code> module:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> functions</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">HashMap</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Function</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> variable_map</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">HashMap</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">usize</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> storage</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractStorage</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            name,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">..</span><span style="color:#B392F0">Contract</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">struct</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Function</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    program</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> visibility</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> mutability</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> returns</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Parameter</span><span style="color:#E1E4E8">&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">enum</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Public</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Private</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    #[default]</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Internal</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">External</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">#[derive(</span><span style="color:#B392F0">Debug</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Clone</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">enum</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Constant</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    #[default]</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">NonPayable</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Payable</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">View</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">Pure</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
Enum variants annotated with #[default] will become default values unless explicitly set.</p>
</blockquote>
<p>Here we’ve created a <code>Contract</code> struct to hold our contract data, and a <code>Function</code> struct to hold our instructions as well as function attributes.
You might also want to import <code>HashMap</code> at the top of the file:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">std</span><span style="color:#F97583">::</span><span style="color:#B392F0">collections</span><span style="color:#F97583">::</span><span style="color:#B392F0">HashMap</span><span style="color:#E1E4E8">;</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
<code>HashMap</code> is a simple KV key-value store allowing us to map strings to data.</p>
</blockquote>
<p>Remember when in the previous part we’ve written a parser that generates an AST tree? It’s about time we used it for something, so we’ll use that parsed data to walk the tree and search for relevant contract data.
Start by implementing a public function <code>create_contracts</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">create_contracts</span><span style="color:#E1E4E8">(source_unit</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnit</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">handle_source_unit</span><span style="color:#E1E4E8">(source_unit)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit</span><span style="color:#E1E4E8">(source_unit</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnit</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#6A737D">    //TODO: Iterate over source_unit.parts</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Your programming instincts are probably telling you to use a for loop here, but no.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit</span><span style="color:#E1E4E8">(source_unit</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnit</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    source_unit</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">parts</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">part</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()))</span><span style="color:#F97583">.</span><span style="color:#B392F0">flatten</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt;&gt;()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnitPart</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Rust encourages a different approach to iteration “the functional programming way” with the help of <code>combinators</code>. Let’s break it down:</p>
<ul>
<li><code>.iter()</code> returns an iterator over the elements of a collection</li>
<li><code>.map()</code> transforms each element of the iterator. Map takes in a closure (kinda like a lambda function), for example <code>|num| num * 2</code> returns value doubled.</li>
<li><code>.flatten()</code> flattens the iterator of iterators into a single iterator, so instead of ending up with <code>Vec&lt;Vec&lt;Contract&gt;&gt;</code> we’ll end up with <code>Vec&lt;Contract&gt;</code></li>
<li><code>.collect()</code> collects the iterator into a <code>Vec&lt;Contract&gt;</code> collection</li>
</ul>
<p>So you simply chain them together to transform your data the way you want it.</p>
<p>You can even skip the .map().flatten() and reduce amount of calls by just using .flat_map() instead:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit</span><span style="color:#E1E4E8">(source_unit</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnit</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    source_unit</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">parts</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">flat_map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">part</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()))</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt;&gt;()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<blockquote>
<p><strong>Note</strong>
We have to clone() the part because we’re passing it by value. Cloning is a rather cheap operation in Rust (at least for small structs) and compiler can optimize it away if it’s not needed, so clone away!</p>
</blockquote>
<p>Now we need to handle SourceUnitPart that holds our contract definition. If we find one - we instantiate a new <code>Contract</code>, handle functions and state variables inside the contract and return the contract instance.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_source_unit_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">SourceUnitPart</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> part {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">SourceUnitPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">ContractDefinition</span><span style="color:#E1E4E8">(_, name, _, parts, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> contract </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(name);</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> _ </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> parts</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">part</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_contract_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> contract))</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;_&gt;&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(contract)</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        _ </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">None</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_contract_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractPart</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> part {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">FunctionDefinition</span><span style="color:#E1E4E8">(_, name, params, attr_list, ret_params, _, statement, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">VariableDefinition</span><span style="color:#E1E4E8">(ty, visibility, name, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">ConstructorDefinition</span><span style="color:#E1E4E8">(_, params, attr_list, _, statement, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            //TODO</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
&amp;mut allows us to pass a mutable reference to a function, so that we can modify contract instance inside the function.</p>
</blockquote>
<p>Let’s first take care of state variables since they’re the low hanging fruit. All we do is insert the state variable into contract’s variable map where we keep track which variable belongs to which slot.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">VariableDefinition</span><span style="color:#E1E4E8">(ty, visibility, name, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">variable_map</span><span style="color:#F97583">.</span><span style="color:#B392F0">insert</span><span style="color:#E1E4E8">(name, contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">variable_map</span><span style="color:#F97583">.</span><span style="color:#B392F0">len</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">            contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">storage</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">slots</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ZERO</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span></code></pre>
<p>Next we have functions.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_contract_part</span><span style="color:#E1E4E8">(part</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ContractPart</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> part {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">FunctionDefinition</span><span style="color:#E1E4E8">(_, name, params, attr_list, ret_params, _, statement, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(statement) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> statement {</span></span>
<span class="line"><span style="color:#6A737D">                //TODO: handle function arguments</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> program </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_statement</span><span style="color:#E1E4E8">(statement, contract);</span></span>
<span class="line"><span style="color:#E1E4E8">                </span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> (visibility, mutability) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_attrs</span><span style="color:#E1E4E8">(attr_list</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">                </span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> returns </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">FunctionReturnParams</span><span style="color:#F97583">::</span><span style="color:#B392F0">ParameterList</span><span style="color:#E1E4E8">(_, </span><span style="color:#B392F0">ParameterList</span><span style="color:#F97583">::</span><span style="color:#B392F0">Param</span><span style="color:#E1E4E8">(_, </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(ret_param), _))) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ret_params</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">                    returns </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[ret_param];</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">functions</span><span style="color:#F97583">.</span><span style="color:#B392F0">insert</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#B392F0">find_function_signature</span><span style="color:#E1E4E8">(name</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), params</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()),</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#B392F0">Function</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                        program</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> program,</span></span>
<span class="line"><span style="color:#E1E4E8">                        visibility</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> visibility,</span></span>
<span class="line"><span style="color:#E1E4E8">                        mutability</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> mutability,</span></span>
<span class="line"><span style="color:#E1E4E8">                        returns</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> returns,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#F97583">..</span><span style="color:#B392F0">Function</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                );</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">ContractPart</span><span style="color:#F97583">::</span><span style="color:#B392F0">VariableDef</span><span style="color:#F97583">...</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_attrs</span><span style="color:#E1E4E8">(attr_list</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">FunctionAttribute</span><span style="color:#E1E4E8">&gt;&gt;) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">FuncVisibility</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">FuncMutability</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_statement</span><span style="color:#E1E4E8">(statement</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Statement</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[]</span><span style="color:#6A737D"> //TODO: handle statements and expressions next</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">find_function_signature</span><span style="color:#E1E4E8">(name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, params</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ParameterList</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> params_str </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ParameterList</span><span style="color:#F97583">::</span><span style="color:#B392F0">Param</span><span style="color:#E1E4E8">((), </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(p), ()) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> params {</span></span>
<span class="line"><span style="color:#E1E4E8">        params_str </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> p</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">ty {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Type</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Type</span><span style="color:#F97583">::</span><span style="color:#B392F0">Bool</span><span style="color:#E1E4E8">(_)) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&quot;bool&quot;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">            _ </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">&quot;&quot;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;{}({})&quot;</span><span style="color:#E1E4E8">, name, params_str)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">get_func_sig</span><span style="color:#E1E4E8">(in_str</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    in_str</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<blockquote>
<p><strong>Note</strong>
The <code>&quot;if let&quot;</code> is a handy Rust syntactic sugar to quickly match on a single match arm.</p>
</blockquote>
<p>Now to handle function attributes we simply iterate over the list of attributes and check whether they’re private, view, etc.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_attrs</span><span style="color:#E1E4E8">(attr_list</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Option</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">FunctionAttribute</span><span style="color:#E1E4E8">&gt;&gt;) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">FuncVisibility</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">FuncMutability</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> visibility </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> mutability </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    attr_list</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">for_each</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">attr</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(attr) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> attr {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> attr {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">FunctionAttribute</span><span style="color:#F97583">::</span><span style="color:#B392F0">Visibility</span><span style="color:#E1E4E8">(v) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    visibility </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> v {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Visibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Public</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Public</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Visibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Private</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Private</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Visibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Internal</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">Internal</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Visibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">External</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncVisibility</span><span style="color:#F97583">::</span><span style="color:#B392F0">External</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">FunctionAttribute</span><span style="color:#F97583">::</span><span style="color:#B392F0">Mutability</span><span style="color:#E1E4E8">(m) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    mutability </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> m {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Mutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Constant</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Constant</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Mutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Payable</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Payable</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Mutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">View</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">View</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">Mutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Pure</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Pure</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                },</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">    (visibility, mutability)</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h1 id="calling-functions">Calling functions</h1>
<p>So far we’ve built each individual piece of our VM, but we still need a way to interact with it. We do so by giving it calldata.</p>
<p>Let’s implement a <code>call</code> function on <code>Contract</code> that takes calldata as hex and returns a a tuple containing a new modified contract and return the top most value from the stack:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">impl</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#79B8FF">Self</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            name,</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">..</span><span style="color:#B392F0">Contract</span><span style="color:#F97583">::</span><span style="color:#B392F0">default</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">call</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;</span><span style="color:#79B8FF">self</span><span style="color:#E1E4E8">, calldata</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;</span><span style="color:#B392F0">str</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">&gt;) {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">functions</span><span style="color:#F97583">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8">calldata</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(function) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> vm </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">VM</span><span style="color:#F97583">::</span><span style="color:#B392F0">new</span><span style="color:#E1E4E8">(function</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">program</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), calldata</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_bytes</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> new_storage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> vm</span><span style="color:#F97583">.</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">storage</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#6A737D">                //Read return values from stack</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> ret</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">&gt; </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">                function</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">returns</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">for_each</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">param</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(r) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> vm</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">stack</span><span style="color:#F97583">.</span><span style="color:#B392F0">pop</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> param {</span></span>
<span class="line"><span style="color:#E1E4E8">                            </span><span style="color:#B392F0">Parameter</span><span style="color:#E1E4E8"> { ty</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Type</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Type</span><span style="color:#F97583">::</span><span style="color:#B392F0">Bool</span><span style="color:#E1E4E8">(_)), </span><span style="color:#F97583">..</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                                    ret</span><span style="color:#F97583">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">BoolLiteral</span><span style="color:#E1E4E8">(r </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">U256</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ONE</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">                            },</span></span>
<span class="line"><span style="color:#E1E4E8">                            _ </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {},</span></span>
<span class="line"><span style="color:#E1E4E8">                        }</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                });</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#E1E4E8">                (</span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    storage</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">View</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">FuncMutability</span><span style="color:#F97583">::</span><span style="color:#B392F0">Pure</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> function</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">mutability { </span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">storage</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">() } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> { new_storage },</span></span>
<span class="line"><span style="color:#E1E4E8">                    </span><span style="color:#F97583">..</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">                }, ret)</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">None</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">self</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">(), </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[]);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h1 id="calling-functions-by-hash">Calling functions by hash</h1>
<p>In EVM you have to call functions by their signature hash. Add a new dependency to our Cargo.toml:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">keccak-hash = </span><span style="color:#9ECBFF">&quot;0.10.0&quot;</span></span></code></pre>
<p>Now import the hash function at the top of <code>tinyvm.rs</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">use</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">keccak_hash</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">{keccak};</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">find_function_signature</span><span style="color:#E1E4E8">(name</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">, params</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">ParameterList</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">...</span></span>
<span class="line"><span style="color:#6A737D">    //format!(&quot;{}({})&quot;, name, params_str)</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">get_func_sig</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;{}({})&quot;</span><span style="color:#E1E4E8">, name, params_str))</span><span style="color:#6A737D">  // &lt;-- Add this</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">pub</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">get_func_sig</span><span style="color:#E1E4E8">(in_str</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">String</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">keccak</span><span style="color:#E1E4E8">(in_str</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_bytes</span><span style="color:#E1E4E8">())[</span><span style="color:#F97583">..</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">]</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_vec</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">iter</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">|</span><span style="color:#E1E4E8">b</span><span style="color:#F97583">|</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">format!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;{:02x}&quot;</span><span style="color:#E1E4E8">, b))</span><span style="color:#F97583">.</span><span style="color:#B392F0">collect</span><span style="color:#F97583">::</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">String</span><span style="color:#E1E4E8">&gt;()</span><span style="color:#6A737D"> // &lt;-- Add this</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Don’t relax just yet, as our contract functions do not contain any OPcodes still. To fix that we have to handle statements and expressions found inside function body.</p>
<h1 id="statements-and-expressions">Statements and Expressions</h1>
<p>To make our functions actually do anything we need to handle statements and expressions.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_statement</span><span style="color:#E1E4E8">(statement</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Statement</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> statement {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Statement</span><span style="color:#F97583">::</span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">(expr, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(expr, contract)</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Statement</span><span style="color:#F97583">::</span><span style="color:#B392F0">Return</span><span style="color:#E1E4E8">(_, expr, _) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> expr {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(expr) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(expr, contract), </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">RETURN</span><span style="color:#E1E4E8">]]</span><span style="color:#F97583">.</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">None</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">RETURN</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(expr</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#B392F0">todo!</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The idea is pretty simple, if we encounter a <code>return</code> statement we add a <code>RETURN</code> OPCode, if we encounter an expression we pass it to another handler.</p>
<p>Now for the final piece of the puzzle, handling of expressions:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(expr</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Expression</span><span style="color:#E1E4E8">, contract</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">&amp;mut</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Contract</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Vec</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">OP</span><span style="color:#E1E4E8">&gt; {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> expr {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">BoolLiteral</span><span style="color:#E1E4E8">(val) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[]</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Variable</span><span style="color:#E1E4E8">(identifier) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> slot </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(found) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">variable_map</span><span style="color:#F97583">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8">identifier</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">                slot </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">found;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH1</span><span style="color:#E1E4E8">(slot </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SLOAD</span></span>
<span class="line"><span style="color:#E1E4E8">            ]</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Assign</span><span style="color:#E1E4E8">(left, _, right) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Variable</span><span style="color:#E1E4E8">(identifier) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">left {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">mut</span><span style="color:#E1E4E8"> slot </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">Some</span><span style="color:#E1E4E8">(found) </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contract</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">variable_map</span><span style="color:#F97583">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8">identifier</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span><span style="color:#F97583">.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">                    slot </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">found;</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">                [</span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">right, contract),</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">PUSH1</span><span style="color:#E1E4E8">(slot </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">u8</span><span style="color:#E1E4E8">), </span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">SSTORE</span><span style="color:#E1E4E8">]]</span><span style="color:#F97583">.</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[]</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Not</span><span style="color:#E1E4E8">(_, expr) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            [</span><span style="color:#B392F0">handle_expression</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">expr, contract), </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">OP</span><span style="color:#F97583">::</span><span style="color:#79B8FF">ISZERO</span><span style="color:#E1E4E8">]]</span><span style="color:#F97583">.</span><span style="color:#B392F0">concat</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">Type</span><span style="color:#E1E4E8">(ty) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> ty {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">Type</span><span style="color:#F97583">::</span><span style="color:#B392F0">Bool</span><span style="color:#E1E4E8">(_) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[],</span><span style="color:#6A737D"> //TODO</span></span>
<span class="line"><span style="color:#E1E4E8">                _ </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">vec!</span><span style="color:#E1E4E8">[],</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Assuming you have been following the steps correctly, you should now have a working VM that can toggle our state variable. Let’s test whether we’re able to toggle the state variable by creating a new unit test:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">    #[test]</span></span>
<span class="line"><span style="color:#E1E4E8">    </span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">test_call_flipper_contract_flip</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> code </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">std</span><span style="color:#F97583">::</span><span style="color:#B392F0">fs</span><span style="color:#F97583">::</span><span style="color:#B392F0">read_to_string</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;./contracts/flipper.sol&quot;</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">.</span><span style="color:#B392F0">expect</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Unable to read source file&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> parsed </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(code</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_str</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;{:#?}&quot;</span><span style="color:#E1E4E8">, parsed);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#B392F0">assert!</span><span style="color:#E1E4E8">(parsed</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_ok</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> parsed {</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Ok</span><span style="color:#E1E4E8">(source_unit) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> contracts </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">create_contracts</span><span style="color:#E1E4E8">(source_unit);</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> contract </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contracts</span><span style="color:#F97583">.</span><span style="color:#B392F0">first</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">assert!</span><span style="color:#E1E4E8">(contract</span><span style="color:#F97583">.</span><span style="color:#B392F0">is_some</span><span style="color:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> flip_func_sig </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">get_func_sig</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;flip()&quot;</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> mutated_contract </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contract</span><span style="color:#F97583">.</span><span style="color:#B392F0">unwrap</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">.</span><span style="color:#B392F0">call</span><span style="color:#E1E4E8">(flip_func_sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_str</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> get_func_sig </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">get_func_sig</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;get()&quot;</span><span style="color:#F97583">.</span><span style="color:#B392F0">to_string</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> ret </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> mutated_contract</span><span style="color:#F97583">.</span><span style="color:#B392F0">call</span><span style="color:#E1E4E8">(get_func_sig</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_str</span><span style="color:#E1E4E8">())</span><span style="color:#F97583">.</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#F97583">match</span><span style="color:#E1E4E8"> ret</span><span style="color:#F97583">.</span><span style="color:#B392F0">as_slice</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">                    [</span><span style="color:#B392F0">solidity</span><span style="color:#F97583">::</span><span style="color:#B392F0">grammar</span><span style="color:#F97583">::</span><span style="color:#B392F0">Expression</span><span style="color:#F97583">::</span><span style="color:#B392F0">BoolLiteral</span><span style="color:#E1E4E8">(val)] </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                        </span><span style="color:#B392F0">assert_eq!</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">val, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                    _ </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">assert!</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&quot;Unexpected return value: {:?}&quot;</span><span style="color:#E1E4E8">, ret)</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">                </span><span style="color:#B392F0">println!</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Return value: {:?}&quot;</span><span style="color:#E1E4E8">, ret);</span></span>
<span class="line"><span style="color:#E1E4E8">                </span></span>
<span class="line"><span style="color:#E1E4E8">            },</span></span>
<span class="line"><span style="color:#E1E4E8">            </span><span style="color:#B392F0">Err</span><span style="color:#E1E4E8">(e) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> </span><span style="color:#B392F0">assert!</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&quot;Error: {:?}&quot;</span><span style="color:#E1E4E8">, e)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>Run this command to confirm that our contract call indeed returns <code>true</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#B392F0">cargo</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">test</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">test_call_flipper_contract_flip</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">--</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">--nocapture</span></span></code></pre>
<p>The output should be:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#B392F0">Return</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">value:</span><span style="color:#E1E4E8"> [BoolLiteral(true)]</span></span>
<span class="line"><span style="color:#79B8FF">test</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">tests::test_call_flipper_contract_flip</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">...</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">ok</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">test</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">result:</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">ok.</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">passed</span><span style="color:#E1E4E8">; </span><span style="color:#B392F0">0</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">failed</span><span style="color:#E1E4E8">; </span><span style="color:#B392F0">0</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">ignored</span><span style="color:#E1E4E8">; </span><span style="color:#B392F0">0</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">measured</span><span style="color:#E1E4E8">; </span><span style="color:#B392F0">5</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">filtered</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">out</span><span style="color:#E1E4E8">; </span><span style="color:#B392F0">finished</span><span style="color:#E1E4E8"> </span><span style="color:#9ECBFF">in</span><span style="color:#E1E4E8"> </span><span style="color:#79B8FF">0.02</span><span style="color:#9ECBFF">s</span></span></code></pre>
<p>And that is it for now! I hope this tutorial was educational and you have actually learned a thing or two about Solidity, EVM or Rust itself.
Next time we’re going to revisit function arguments, calldata, constructors, getters and more.
You can also download the entire project <a href="https://github.com/TheoXD/tinysol/archive/ae646a588b808fd8f404c94aaa5d3c13c5c2bfbc.zip">here</a>
Until next time!</p>

    </article>
  </main>

          </main>
        </div>
        <footer class="footer footer-center block mb-5 pt-10">
  <div class="pb-2">
    Copyright &copy; 2023 Theo Hallenius
  </div>
  <div class="inline opacity-75">
    <!-- Thanks for using this template. Please keep this line to support my work :) -->
    <a href="https://astro-modern-personal-website.netlify.app/" target="_blank" class="font-bold">Website Template</a> developed by
    <a href="https://manuelernestog.github.io" target="_blank" class="font-bold">Manuel Ernesto ⚡️</a>
  </div>
</footer>
      </div>
      <div class="drawer-side bg-base-100">
  <label for="my-drawer" class="drawer-overlay bg-base-100"></label>
  <div class="menu flex flex-col flex-nowrap p-4 overflow-y-auto w-[20rem] bg-base-100 text-base-content">
    <div class="w-fit">
      <a href="/">
        <div class="avatar transition ease-in-out w-1/2 hover:scale-[102%] block m-auto mt-3 mb-8 h-36">
          <div>
            <img class="mask mask-circle" alt="Profile image" width="300" height="300" src="/_astro/profile_Z1AnH13.webp" loading="lazy" decoding="async">
          </div>
          <h1 class="m-2 font-bold text-lg font-medium">Theo Hallenius</h1>
        </div>
        <p class="w-full text-center">Blockchain/Software Developer</p>
      </a>
    </div>


    <ul class="grow shrink mt-6">
      <!-- Sidebar content here -->
      <li><a id="home" href="/">Home</a></li>
      <li><a id="projects" href="/projects">Projects</a></li>
      <li><a id="blog" href="/blog/">Blog</a></li>
      <li><a id="cv" href="/cv">CV</a></li>
      <li><a href="mailto:theo.hallenius@gmail.com" target="_blank" referrerpolicy="no-referrer-when-downgrade">Contact</a></li>
    </ul>


    <div class="social-icons px-4 my-2 flex self-center">
      <!-- 
      <a
        href="https://www.artstation.com/theoxd"
        target="_blank"
        class="mx-3"
        aria-label="Art Station"
        title="Art Station"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          style="fill: currentColor;transform: ;msFilter:;"
          ><path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M5 2h2v3H5zm4 0h2v3H9zm4 0h2v3h-2zm6 7h-2V7H3v11c0 1.654 1.346 3 3 3h8c1.654 0 3-1.346 3-3h2c1.103 0 2-.897 2-2v-5c0-1.103-.897-2-2-2zm-4 9a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V9h10v9zm2-2v-5h2l.002 5H17z"
          ></path></svg
        >
      </a>
    -->
      <a href="https://github.com/TheoXD" target="_blank" class="mx-3" aria-label="Github" title="Github">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"></path>
        </svg>
      </a>
      <a href="https://twitter.com/TheoHallenius" target="_blank" class="mx-3" aria-label="Twitter" title="Twitter">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19.633 7.997c.013.175.013.349.013.523 0 5.325-4.053 11.461-11.46 11.461-2.282 0-4.402-.661-6.186-1.809.324.037.636.05.973.05a8.07 8.07 0 0 0 5.001-1.721 4.036 4.036 0 0 1-3.767-2.793c.249.037.499.062.761.062.361 0 .724-.05 1.061-.137a4.027 4.027 0 0 1-3.23-3.953v-.05c.537.299 1.16.486 1.82.511a4.022 4.022 0 0 1-1.796-3.354c0-.748.199-1.434.548-2.032a11.457 11.457 0 0 0 8.306 4.215c-.062-.3-.1-.611-.1-.923a4.026 4.026 0 0 1 4.028-4.028c1.16 0 2.207.486 2.943 1.272a7.957 7.957 0 0 0 2.556-.973 4.02 4.02 0 0 1-1.771 2.22 8.073 8.073 0 0 0 2.319-.624 8.645 8.645 0 0 1-2.019 2.083z"></path>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/theo-hallenius/" target="_blank" class="mx-3" aria-label="Linkedin" title="Linkedin">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><circle cx="4.983" cy="5.009" r="2.188"></circle><path d="M9.237 8.855v12.139h3.769v-6.003c0-1.584.298-3.118 2.262-3.118 1.937 0 1.961 1.811 1.961 3.218v5.904H21v-6.657c0-3.27-.704-5.783-4.526-5.783-1.835 0-3.065 1.007-3.568 1.96h-.051v-1.66H9.237zm-6.142 0H6.87v12.139H3.095z"></path>
        </svg>
      </a>

      <a href="/rss.xml" target="_blank" class="mx-3" aria-label="RSS Feed" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19 20.001C19 11.729 12.271 5 4 5v2c7.168 0 13 5.832 13 13.001h2z"></path><path d="M12 20.001h2C14 14.486 9.514 10 4 10v2c4.411 0 8 3.589 8 8.001z"></path><circle cx="6" cy="18" r="2"></circle>
        </svg>
      </a>
    </div>
  </div>
</div>
    </div>

    <div class="fixed bottom-0 right-0 w-1/6">
      <img src="/signature2.png" alt="overlay">
    </div>
    
  </body></html>